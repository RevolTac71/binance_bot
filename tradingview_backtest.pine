// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š EMA Pullback Scalper v4 â€” ìˆ˜ìˆ˜ë£Œ í˜„ì‹¤ ë°˜ì˜ & ë¦¬í˜ì¸íŒ… ì œê±°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì£¼ë ¥ TF: 5ë¶„ë´‰ (ATRì´ ìˆ˜ìˆ˜ë£Œë¥¼ ì†Œí™”í•  ìˆ˜ ìˆëŠ” ìµœì†Œ ë‹¨ìœ„)
// ì¶”ì„¸ TF: 15ë¶„ë´‰ EMA (lookahead ë¦¬í˜ì¸íŒ… ì°¨ë‹¨)
// ì§„ì…: ë§¤ë„ì„¸ ê³ ê°ˆí˜• ëˆŒë¦¼ëª© (ê±°ë˜ëŸ‰ ê°ì†Œ + ë°‘ê¼¬ë¦¬ ì–‘ë´‰)
// ì²­ì‚°: ATR TP/SL (R:R 1:2) + Chandelier Trailing
// ìê¸ˆ: 1% ê³ ì • ë¦¬ìŠ¤í¬, 15% ìº¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//@version=5
strategy("EMA Pullback Scalper v4", overlay=true,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=10,
     initial_capital=100,
     commission_type=strategy.commission.percent,
     commission_value=0.1,
     slippage=1,
     calc_on_every_tick=false,
     process_orders_on_close=false)

// â”€â”€â”€ ì…ë ¥ íŒŒë¼ë¯¸í„° â”€â”€â”€
// ì¶”ì„¸ í•„í„° (15ë¶„ë´‰)
ema_fast_len   = input.int(50,  "ì¶”ì„¸ EMA Fast", group="ì¶”ì„¸ í•„í„°")
ema_slow_len   = input.int(100, "ì¶”ì„¸ EMA Slow", group="ì¶”ì„¸ í•„í„°")
trend_tf       = input.timeframe("15", "ì¶”ì„¸ íƒ€ì„í”„ë ˆì„", group="ì¶”ì„¸ í•„í„°")

// ëˆŒë¦¼ëª© ì§„ì… ì¡°ê±´ (5ë¶„ë´‰)
ema_pullback   = input.int(20,  "Pullback EMA", group="ì§„ì… ì¡°ê±´")
rsi_len        = input.int(14,  "RSI Length",    group="ì§„ì… ì¡°ê±´")
rsi_threshold  = input.int(45,  "RSI ê³¼ë§¤ë„ ê¸°ì¤€", group="ì§„ì… ì¡°ê±´")
rsi_lookback   = input.int(5,   "RSI ìœˆë„ìš° (ë´‰ìˆ˜)", group="ì§„ì… ì¡°ê±´")
wick_ratio     = input.float(0.6, "ë°‘ê¼¬ë¦¬ ë¹„ìœ¨ (body ëŒ€ë¹„)", group="ì§„ì… ì¡°ê±´", step=0.1)

// ATR TP/SL (ìˆ˜ìˆ˜ë£Œë¥¼ ì†Œí™”í•  ìˆ˜ ìˆë„ë¡ ë„“í˜)
atr_len        = input.int(14,  "ATR Length",     group="TP/SL")
atr_tp_mult    = input.float(3.0,  "TP ë°°ìˆ˜ (ATRÃ—)", group="TP/SL", step=0.5)
atr_sl_mult    = input.float(1.5, "SL ë°°ìˆ˜ (ATRÃ—)", group="TP/SL", step=0.25)

// Chandelier Trailing (ì—¬ìœ ìˆê²Œ ì¡°ì •)
trail_activate = input.float(1.5, "Trailing í™œì„±í™” (ATRÃ—)", group="Trailing", step=0.1)
trail_offset   = input.float(0.8, "Trailing SL ê±°ë¦¬ (ATRÃ—)", group="Trailing", step=0.1)
fee_pct        = input.float(0.22, "ì™•ë³µ ìˆ˜ìˆ˜ë£Œ+ìŠ¬ë¦¬í”¼ì§€ (%)", group="Trailing", step=0.01)

// ìê¸ˆ ê´€ë¦¬
risk_pct       = input.float(1.0, "ë¦¬ìŠ¤í¬ ë¹„ìœ¨ (%)", group="ìê¸ˆê´€ë¦¬", step=0.1)
max_invest_pct = input.float(15.0, "ìµœëŒ€ íˆ¬ì… ìº¡ (%)", group="ìê¸ˆê´€ë¦¬", step=1.0)

// â”€â”€â”€ 15ë¶„ë´‰ ì¶”ì„¸ í•„í„° (ë¦¬í˜ì¸íŒ… ì°¨ë‹¨) â”€â”€â”€
// [1]ê³¼ lookahead_onì„ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì™„ì„±ëœ ì§ì „ 15ë¶„ë´‰ ê¸°ì¤€
ema_fast_htf = request.security(syminfo.tickerid, trend_tf,
     ta.ema(close, ema_fast_len)[1], lookahead=barmerge.lookahead_on)
ema_slow_htf = request.security(syminfo.tickerid, trend_tf,
     ta.ema(close, ema_slow_len)[1], lookahead=barmerge.lookahead_on)
trend_up = ema_fast_htf > ema_slow_htf

// â”€â”€â”€ 5ë¶„ë´‰ ì§„ì… ì§€í‘œ â”€â”€â”€
ema20      = ta.ema(close, ema_pullback)
rsi_val    = ta.rsi(close, rsi_len)
atr_val    = ta.atr(atr_len)
vol_ma     = ta.sma(volume, 20)

// â”€â”€â”€ ì§ì „ ì™„ì„± ìº”ë“¤ ê¸°ì¤€ ì¡°ê±´ (Repainting ë°©ì§€) â”€â”€â”€
// ëª¨ë“  ì¡°ê±´ì€ [1] (ì§ì „ ì™„ì„±ë´‰)ì„ ì°¸ì¡°

// 1. RSI ìœˆë„ìš°: ìµœê·¼ Në´‰ ì´ë‚´ì— RSI < threshold í„°ì¹˜ ì´ë ¥
rsi_touched = false
for i = 1 to rsi_lookback
    if rsi_val[i] < rsi_threshold
        rsi_touched := true
        break

// 2. ì§ì „ë´‰ì´ EMA20 ì•„ë˜ì—ì„œ ë§ˆê° (ëˆŒë¦¼ëª© ì˜ì—­ ì§„ì…)
pullback_zone = close[1] < ema20[1]

// 3. ë§¤ë„ì„¸ ê³ ê°ˆ: ì§ì „ë´‰ ê±°ë˜ëŸ‰ì´ í‰ê·  ì´í•˜ (= ë§¤ë„ ì••ë ¥ ì†Œì§„)
vol_exhaustion = volume[1] < vol_ma[1]

// 4. ë°‘ê¼¬ë¦¬ ì–‘ë´‰ (í•˜ë‹¨ ìœ„í¬ê°€ ê¸¸ê³  ì‹¤ì²´ê°€ ì–‘ë´‰ = ë§¤ìˆ˜ì„¸ ìœ ì… ì‹œì‘)
body_size  = math.abs(close[1] - open[1])
lower_wick = math.min(close[1], open[1]) - low[1]
is_bullish = close[1] > open[1]
has_wick   = body_size > 0 ? (lower_wick / body_size >= wick_ratio) : (lower_wick > 0)
wick_bullish = is_bullish and has_wick

// â”€â”€â”€ ë§¤ìˆ˜ ì‹œê·¸ë„ ì¢…í•© â”€â”€â”€
long_signal = trend_up and rsi_touched and pullback_zone and vol_exhaustion and wick_bullish

// â”€â”€â”€ ATR ê¸°ë°˜ ë™ì  TP/SL â”€â”€â”€
tp_distance = atr_val * atr_tp_mult
sl_distance = atr_val * atr_sl_mult
fee_buffer  = close * (fee_pct / 100)

// â”€â”€â”€ ê³ ì • ë¦¬ìŠ¤í¬ ëª¨ë¸ í¬ì§€ì…˜ ì‚¬ì´ì§• â”€â”€â”€
equity_val   = strategy.equity
risk_amount  = equity_val * (risk_pct / 100)
sl_per_unit  = sl_distance
qty_risk     = sl_per_unit > 0 ? risk_amount / sl_per_unit : 0

// íˆ¬ì…ê¸ˆ ì œí•œ (15% ìº¡)
max_invest   = equity_val * (max_invest_pct / 100)
invest_usdt  = qty_risk * close
qty_final    = invest_usdt > max_invest ? max_invest / close : qty_risk

// â”€â”€â”€ Chandelier Trailing ìƒíƒœ ë³€ìˆ˜ â”€â”€â”€
var float trail_entry = na
var float trail_atr   = na
var float trail_fee   = na
var float trail_high  = na
var bool  trail_on    = false

// â”€â”€â”€ ì§„ì… ì‹¤í–‰ â”€â”€â”€
if long_signal and strategy.position_size == 0 and qty_final > 0
    entry_price = close
    tp_price    = entry_price + tp_distance
    sl_price    = entry_price - sl_distance

    strategy.entry("Long", strategy.long, qty=qty_final)
    strategy.exit("TP/SL", "Long", limit=tp_price, stop=sl_price)

    trail_entry := entry_price
    trail_atr   := atr_val
    trail_fee   := fee_buffer
    trail_high  := entry_price
    trail_on    := false

// â”€â”€â”€ Chandelier Trailing Stop ê´€ë¦¬ â”€â”€â”€
if strategy.position_size > 0
    trail_high := math.max(nz(trail_high), high)

    // í™œì„±í™”: í˜„ì¬ê°€ â‰¥ entry + ATRÃ—1.5 + fee_buffer
    chandelier_threshold = nz(trail_entry) + nz(trail_atr) * trail_activate + nz(trail_fee)
    if not trail_on and close >= chandelier_threshold
        trail_on := true

    // í™œì„±í™” í›„: SL = max(ê¸°ì¡´SL, ìµœê³ ê°€ - ATRÃ—0.8 - fee_buffer)
    if trail_on
        new_sl       = nz(trail_high) - nz(trail_atr) * trail_offset - nz(trail_fee)
        orig_sl      = nz(trail_entry) - nz(trail_atr) * atr_sl_mult
        effective_sl = math.max(orig_sl, new_sl)
        tp_target    = nz(trail_entry) + nz(trail_atr) * atr_tp_mult
        strategy.exit("Chandelier", "Long", limit=tp_target, stop=effective_sl)
else
    trail_entry := na
    trail_atr   := na
    trail_fee   := na
    trail_high  := na
    trail_on    := false

// â”€â”€â”€ ì‹œê°í™” â”€â”€â”€
plot(ema_fast_htf, "EMA50 (15m)", color=color.new(color.blue, 30), linewidth=2)
plot(ema_slow_htf, "EMA100 (15m)", color=color.new(color.orange, 30), linewidth=2)
plot(ema20, "EMA20 (5m)", color=color.new(color.white, 40), linewidth=1)

plotshape(long_signal and strategy.position_size == 0,
     title="Buy Signal", style=shape.triangleup,
     location=location.belowbar, color=color.lime, size=size.small)

bgcolor(trend_up ? color.new(color.green, 95) : color.new(color.red, 95))

// â”€â”€â”€ ì •ë³´ í…Œì´ë¸” â”€â”€â”€
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "ATR (14)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 0, str.tostring(atr_val, "#.####"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, "TP (ATRÃ—" + str.tostring(atr_tp_mult) + ")", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(tp_distance, "#.####"), text_color=color.green, text_size=size.small)
    table.cell(infoTable, 0, 2, "SL (ATRÃ—" + str.tostring(atr_sl_mult) + ")", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(sl_distance, "#.####"), text_color=color.red, text_size=size.small)
    table.cell(infoTable, 0, 3, "R:R", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 3, "1 : " + str.tostring(atr_tp_mult / atr_sl_mult, "#.#"), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 4, "RSI", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(rsi_val, "#.##"), text_color=rsi_val < rsi_threshold ? color.lime : color.white, text_size=size.small)
    table.cell(infoTable, 0, 5, "Trail", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 5, trail_on ? "ğŸŸ¢ ON" : "âšª OFF", text_color=trail_on ? color.lime : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 6, "ì¶”ì„¸ (15m)", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 6, trend_up ? "ğŸ”¼ ìƒìŠ¹" : "ğŸ”½ í•˜ë½", text_color=trend_up ? color.lime : color.red, text_size=size.small)
    table.cell(infoTable, 0, 7, "ì „ëµ", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 7, "ë§¤ë„ì„¸ ê³ ê°ˆ ëˆŒë¦¼ëª©", text_color=color.aqua, text_size=size.small)
